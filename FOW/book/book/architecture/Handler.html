<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Handler - Layered Fog Of War documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../documentation.html">Documentation</a></li><li class="chapter-item expanded "><a href="../../book/index.html">Book</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../book/getting_started.html">Getting Started</a></li><li class="chapter-item expanded "><a href="../../book/architecture/index.html">Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../book/architecture/Handler.html" class="active">Handler</a></li><li class="chapter-item expanded "><a href="../../book/architecture/Floor.html">Floor</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../reference.html">C++ API Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/classes.html">Classes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/classes/AFOW_Handler.html">AFOW_Handler</a></li><li class="chapter-item expanded "><a href="../../reference/classes/IFOW_CollisionEntity_Interface.html">IFOW_CollisionEntity_Interface</a></li><li class="chapter-item expanded "><a href="../../reference/classes/IFOW_DrawingEntity_Interface.html">IFOW_DrawingEntity_Interface</a></li><li class="chapter-item expanded "><a href="../../reference/classes/IFOW_Entity_Interface.html">IFOW_Entity_Interface</a></li><li class="chapter-item expanded "><a href="../../reference/classes/IFOW_GeometryEntity_Interface.html">IFOW_GeometryEntity_Interface</a></li><li class="chapter-item expanded "><a href="../../reference/classes/IFOW_VisibilityEntity_Interface.html">IFOW_VisibilityEntity_Interface</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_CollisionHandler.html">UFOW_CollisionHandler</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_DrawerComponent.html">UFOW_DrawerComponent</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_Drawer_Shared.html">UFOW_Drawer_Shared</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_EntityContainer.html">UFOW_EntityContainer</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_EntityVisibilityHandler.html">UFOW_EntityVisibilityHandler</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_Floor.html">UFOW_Floor</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_LayerHandler.html">UFOW_LayerHandler</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_LayerSetting.html">UFOW_LayerSetting</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_Rasterizer.html">UFOW_Rasterizer</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_TextureSample.html">UFOW_TextureSample</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_Tile_Class.html">UFOW_Tile_Class</a></li><li class="chapter-item expanded "><a href="../../reference/classes/UFOW_VisibilityE_Component.html">UFOW_VisibilityE_Component</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Layered Fog Of War documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="handler"><a class="header" href="#handler">Handler</a></h1>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of contents</a></h2>
<ul>
<li><a href="#explanation">Explanation</a>
<ul>
<li><a href="#settings">Settings</a>
<ul>
<li><a href="#editor-debug-setting">Editor debug setting</a></li>
<li><a href="#fog-setting">Fog setting</a></li>
<li><a href="#update-settings">Update settings</a></li>
<li><a href="#module-settings">Module settings</a></li>
<li><a href="#rendering-settings">Rendering settings</a></li>
</ul>
</li>
<li><a href="#initialisation">Initialisation</a></li>
<li><a href="#updates">Updates</a></li>
</ul>
</li>
</ul>
<h2 id="explanation"><a class="header" href="#explanation">Explanation</a></h2>
<p><a href="/book/architecture/FOWHandler.html"><code>class: AFOWHandler</code></a> is a singleton used to store <a href="/book/architecture/Floor.html">Floors</a>
and used to change the Fog settings (Pixel size, Encoding, Collision system ...). It defines
the initialisation and the update loop. All initialisation happens during the begin play unless
for the floor generation that is instantiated straight into the editor.</p>
<h3 id="settings"><a class="header" href="#settings">Settings</a></h3>
<h4 id="editor-debug-setting"><a class="header" href="#editor-debug-setting">Editor debug setting</a></h4>
<ul>
<li>"ShowGrid": display the grid delimited by the tile. Floors are snapped to this grid.</li>
<li>"ShowFloors": display the 3D box representing the floors. The pink square is the real position of
the floor, it will be aligned to the grid. The yellow square is the 3D Fog representation.</li>
</ul>
<h4 id="fog-setting"><a class="header" href="#fog-setting">Fog setting</a></h4>
<ul>
<li>Change the fog dimension and precision by changing "PixelSize" and adding
floors in the "FOWFloors" array.</li>
<li>Change the tile dimension by modifying their pixel number from "TilePixelNumber" Enum. Changing
tile size might become interesting for high fog precision, it will reduce the number of tile
merging and will allow the usage of bigger register for the tile merging.</li>
<li>Change the default fog status at start with "ChannelToClearAtStart". Useful if you
have a map with hidden area and the rest visible. Use "AFOW_DrawingE_Custom" with "UFOW_FloorStartUpLayer"
to add fog where it's needed. Fog will be cleared and re-draw during the initialisation and the very first frame.</li>
<li>Change "LayerHandler_Class" to organise the layer merging as you pleased.</li>
<li>Change "FOWFloorTiles_Class" to make the best fit with "TilePixelNumber", but also to set the number
of channels used by each team for your game.</li>
</ul>
<h4 id="update-settings"><a class="header" href="#update-settings">Update settings</a></h4>
<ul>
<li>Change the right of the FOW to use or not multithreading/Task/ComputeShader (compute shader not done yet).</li>
<li>Change the update rate of the FOW but I do not recommend using it, the render will be impacted by it.
It's better to enable the task and let the FOW do discrete updates if necessary.</li>
</ul>
<h4 id="module-settings"><a class="header" href="#module-settings">Module settings</a></h4>
<p>Modules that can be changed in the handler are stored under the "Settings|Class" section. There is
a differentiation between static and dynamic because some modules can be more or less optimized
depending on those two parameters (The AABBCollisionHandler has an update time super long for dynamic objects).</p>
<h4 id="rendering-settings"><a class="header" href="#rendering-settings">Rendering settings</a></h4>
<ul>
<li>Change "FOWShader_Class" to change the render system of the FOW. 3 different materials are provided
with the plugin:
<ul>
<li>"MPP_FOW_Floors": for flat game</li>
<li>"MPP_FOW_FloorsTransparency": for games with verticality</li>
<li>"MUI_FOW_Minimap": for the minimap</li>
</ul>
</li>
</ul>
<h3 id="initialisation"><a class="header" href="#initialisation">Initialisation</a></h3>
<p>The initialisation of the FOW happens in the begin play and can be delayed if your pipeline needs it.
Initialization is split into many sections:</p>
<ul>
<li>"InitNetwork" will create a "Replicated" environment only if the game isn't standalone and if
the layer setting class is correctly set. Set network setting as the right to override many values
from the Handler to provide the accessibility to different clients. Thus it has to be executed first.</li>
<li>"InitTeams" isn't used and will be deleted.</li>
<li>"InitFOWFloorsTiles" Allocates the memory used by the floor. The FOW cannot do anything without it.
The tiles must be initialized before the game shader.</li>
<li>"InitGameShader" Generates "FOWTextureSample" that will be linked to the instantiated "FOWShader_Class".
You can override this to generate more material if needed. However, you have the possibility to create
and register texture sample at any time; don't force yourself to do everything in this method.</li>
<li>"InitFOWUpdate" is the most interesting method. If you have pipeline trouble, I recommend to let every
other initialization call and to delay only this one. Until this call is made, no update from the fog but
even from this entity or the collision system will happen. <strong>Please be very cautious to call "FinalizeInitialization"
just after the call of this method.</strong></li>
</ul>
<h4 id="visual-representation-of-the-initialisation-pipeline"><a class="header" href="#visual-representation-of-the-initialisation-pipeline">Visual representation of the initialisation pipeline</a></h4>
<p><img src="../../assets/FOWInitialisation.drawio.png" alt="FOWHandler initialisation pipeline" /></p>
<h3 id="updates"><a class="header" href="#updates">Updates</a></h3>
<p>By default, the update happens during the actor tick. Every component of the FOW will be updated during
this sequence unless for the "FOWTextureSample". The update will be done at once if no asynchronous
tasks are requested and will be managed by two methods:</p>
<ul>
<li>"FOWUpdate_Begin" manages every update that needs to happen to let drawers generate fog fragment.
It'll update the dynamic Entities first and then the collision. It will also be responsible for multithreading
initialization.</li>
<li>"FOWUpdate_End" is called after that the drawers have generated their fog fragment. Depending on the usage
of task or compute shader, it'll be called right after the begin update or later in the frame. Fog fragment
will be sorted and distributed to floors to update the fog state. Once updated transient drawer will be deleted
and all "visibleEntity" will update their state to turn on/off their render.</li>
</ul>
<p>The "FOWTextureSample" has a special place to be updated because of the engine camera update time. To generate
fog sample the sample has to be aware of the position of the camera; however, Unreal updates their position at
the end of the tick. To prevent sample from sending wrong texture information, their updates happen at the very
end of the world tick. There is a second reason of why their update is separated and independent. In case
of long update, the FOW can skip an update frame if using asynchronous update. It doesn't impact the render
to not change the fog state, however, fog data on the GPU has to be perfectly synchronized with game or
artifacts might show up.</p>
<h4 id="visual-representation-of-the-updates-pipeline"><a class="header" href="#visual-representation-of-the-updates-pipeline">Visual representation of the Updates pipeline</a></h4>
<h2 id=""><a class="header" href="#"><img src="../../assets/FOWUpdate.drawio.png" alt="FOWHandler update pipeline" /></a></h2>
<p><em>Documentation built with <a href="https://github.com/PsichiX/unreal-doc"><strong><code>Unreal-Doc</code> v1.0.9</strong></a> tool by <a href="https://github.com/PsichiX"><strong><code>PsichiX</code></strong></a></em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../book/architecture/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../book/architecture/Floor.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../book/architecture/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../book/architecture/Floor.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
